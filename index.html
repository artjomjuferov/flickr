<!DOCTYPE html>
<html>
    <head>
        <title>
            Use flickr!
        </title>
        <script src="jquery-1.10.2.min.js"></script>
        <script src="flickrapi.dev.js"></script>
    </head>
    <body>
        <form data-bind="submit:getPhotos">
            Enter Author: <input type="text" data-bind='value:author, valueUpdate: "afterkeydown"' />
            <label>
                <input name="way" type="radio" value="A" 
                         data-bind="checked: radioWay" />
                Pagination
            </label>
            <label>
                <input name="way" type="radio" value="B" 
                         data-bind="checked: radioWay" />
                Without
            </label>
            <button type="submit" data-bind="enable: author().length > 0">Get</button>
        </form>
        
        <p data-bind='visible: displayButtons'>
            Sort Albums
            <button data-bind="click: albums.sort(byName), enable: albums().length > 1">By Name</button>
            <button data-bind="click: albums.sort(byPhotos), enable: albums().length > 1">By Amount of photos</button>
        </p>
        
        
        <div data-bind='foreach: albums' >
            <div style="border-style: solid;border-width: 1px;">
                <div>
                    <span data-bind='text: title._content'></span>
                    <span data-bind='text: photos'> </span>
                
                    <button data-bind="click: $root.showPagination, visible: photos.length>0">Show photos with pagination</button>
                    <button data-bind="click: $root.showWithout, visible: photos.length>0">Show photos without</button>
                    <!-- <img data-bind="attr:{src: getPhotoUrl($data)}" />  -->
                
                    <div data-bind='foreach: allPhotos, visible: visAlbum'>
                        <span data-bind='text: title'></span>
                        <img data-bind="attr:{src: getPhotoUrl($data)}" /> 
                    </div>
                </div>
                
            </div>
        </div>
        
        <script src="knockout.js"></script>
        <script type="text/javascript">
           var flickr = new Flickr({
              api_key: "3fc6d015f3fa928888e3501230ee0657"
            });

        
        function getPhotoUrl(item){
            console.log(item);
            var url = 'http://farm' + item.farm + '.static.flickr.com/' + item.server + '/' + item.id + '_' + item.secret + '_m.jpg'
            return url;
        }
          
            // function Album(url, name)
            // {
            //     this.url = url;
            //     this.name = name;
            //     this.photos = [];
            //     this.visAlbum =  ko.observable(false);
            // }
            // Album.prototype.addPhoto = function(photo){
            //     this.photos.push(photo);
            // }
           
            // function getFromFlicker(albumsN, photosN){
            //     var albums = []; 
            //     for(var i=0; i<albumsN; i++){
            //         var tmpAlbum = new Album("path/"+String(i),String(i));
            //         for(var j=0; j<Math.floor(Math.random()*photosN); j++){
            //             tmpAlbum.addPhoto(new Photo("path/"+String(i)+"/"+String(j), Math.floor(Math.random()*1000), String(j)));
            //         }
            //         albums.push(tmpAlbum);
            //     }
            //     return albums;
            // }
           
            var ViewModel = function() {
                this.author = ko.observable("");
                this.displayButtons = ko.observable(false);
                this.radioWay = ko.observable("B");
                this.albums = ko.observableArray([]);
                
                this.getPhotos = function () {
                    if ((this.author() != "")){
                        if (this.radioWay() === "B"){
                            this.displayButtons(true);
                            var albums = this.albums;
                            var id;
                            flickr.people.findByUsername({
                                username: this.author()
                            }, function(errU, result) {
                              if(errU) { alert(errU); return; }
                                flickr.photosets.getList({
                                  user_id: result.user.id
                                }, function(errS, result) {
                                  if(errS) { alert(errS); return; }
                                    //add attr for visibility
                                    var arr = result.photosets.photoset;
                                    $.each(arr, function(i,item) {
                                        item['visAlbum'] = ko.observable(false);
                                        item['allPhotos'] =  ko.observableArray([]);
                                    });
                                    albums(arr);
                                });
                            });
                        }else{
                            this.displayButtons(false);
                        }
                    }    
                };

                this.showPagination = function (album) {
                    // album.visAlbum(true);
                };
                
                this.showWithout = function (album) {
                    flickr.photosets.getPhotos({
                        photoset_id: album.id
                    }, function(err, result){
                        if(err) { alert(err); return; }
                        album.allPhotos(result.photoset.photo);
                    });
                    album.visAlbum(true);
                };
                
            };
            ko.bindingHandlers.hidden = {
              update: function(element, valueAccessor){
                var value = ko.utils.unwrapObservable(valueAccessor());
             
                ko.bindingHandlers.visible.update(element, function() {
                  return !value;
                });
             
              }
            };
            ko.applyBindings(new ViewModel());
        
            //sorts
            var byName = function(a, b) {
                if(a.name < b.name){
                    return -1;
                }else if(a.name > b.name){
                    return 1;
                }else{
                    return 0;
                }
            };

            var byPhotos = function(a, b) {
                if(a.photos.length < b.photos.length){
                    return -1;
                }else if(a.photos.length > b.photos.length){
                    return 1;
                }else{
                    return 0;
                }
            };


// Key:
// 3fc6d015f3fa928888e3501230ee0657
// Secret:
// fa0ca8dda96dd5df
// id:
// 130814631@N07


// $.each(data.items, function(i,item) {
//                                   $("<img/>").attr("src", item.media.m).appendTo("#images");
//                                 });
             
        </script>
    </body>
</html>